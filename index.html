<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>宇豐 — 案件管理系統</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Noto+Sans+TC:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#FAFAF9;--surface:#FFFFFF;--surface-hover:#F7F7F5;--surface-active:#F0EFED;
  --sidebar-bg:#18181B;--sidebar-text:#A1A1AA;--sidebar-hover:#27272A;--sidebar-active:#3F3F46;
  --border:#E4E4E7;--border-light:#F4F4F5;
  --text-primary:#18181B;--text-secondary:#71717A;--text-tertiary:#A1A1AA;
  --accent:#2563EB;--accent-hover:#1D4ED8;--accent-light:#EFF6FF;--accent-muted:#DBEAFE;
  --green:#16A34A;--green-light:#F0FDF4;--green-border:#BBF7D0;
  --amber:#D97706;--amber-light:#FFFBEB;--amber-border:#FDE68A;
  --red:#DC2626;--red-light:#FEF2F2;--red-border:#FECACA;
  --purple:#7C3AED;--purple-light:#F5F3FF;
  --orange:#EA580C;--orange-light:#FFF7ED;--orange-border:#FED7AA;
  --radius:6px;--radius-lg:10px;
  --shadow-sm:0 1px 2px rgba(0,0,0,.04);
  --shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --shadow-md:0 4px 6px -1px rgba(0,0,0,.07),0 2px 4px -2px rgba(0,0,0,.05);
  --font-body:'DM Sans','Noto Sans TC',sans-serif;
  --font-display:'Noto Sans TC','DM Sans',sans-serif;
  --font-mono:'SF Mono','Fira Code',monospace;
}
html{font-size:14px}
body{font-family:var(--font-body);background:var(--bg);color:var(--text-primary);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
::selection{background:var(--accent-muted)}

/* ─── Layout ─── */
.app{display:flex;min-height:100vh}
.sidebar{width:220px;min-width:220px;background:var(--sidebar-bg);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto;z-index:10}
.sidebar::-webkit-scrollbar{width:0}
.main{flex:1;min-width:0;padding:28px 36px 40px;max-width:1100px}
@media(max-width:1400px){.main{max-width:100%}}

/* ─── Sidebar ─── */
.s-head{padding:20px 16px 16px;border-bottom:1px solid #27272A}
.s-head h1{font-family:var(--font-display);font-size:15px;font-weight:700;color:#FAFAFA;letter-spacing:.5px}
.s-head p{font-size:11px;color:#52525B;margin-top:2px;font-weight:400}
.s-switch{display:flex;align-items:center;gap:6px;margin-top:10px;padding:5px 8px;border-radius:4px;font-size:11px;color:#71717A;cursor:pointer;border:1px solid #27272A;transition:all .15s}
.s-switch:hover{border-color:#3F3F46;color:#A1A1AA;background:#27272A}
.s-switch svg{width:12px;height:12px}
.s-nav{flex:1;padding:8px 8px 16px}
.s-section{padding:16px 8px 4px;font-size:10px;font-weight:600;color:#52525B;letter-spacing:1.5px;text-transform:uppercase}
.s-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:5px;color:var(--sidebar-text);font-size:13px;cursor:pointer;transition:all .12s;margin:1px 0;font-weight:400}
.s-item:hover{background:var(--sidebar-hover);color:#D4D4D8}
.s-item.active{background:var(--sidebar-active);color:#FAFAFA;font-weight:500}
.s-item svg{width:15px;height:15px;opacity:.6;flex-shrink:0}
.s-item.active svg{opacity:1}
.s-foot{padding:12px 16px;border-top:1px solid #27272A;font-size:10px;color:#3F3F46}

/* ─── Typography ─── */
.page-title{font-family:var(--font-display);font-size:20px;font-weight:700;color:var(--text-primary);letter-spacing:-.2px}
.section-title{font-size:13px;font-weight:600;color:var(--text-primary);letter-spacing:-.1px}
.label{font-size:12px;font-weight:500;color:var(--text-secondary);letter-spacing:.1px}

/* ─── Components ─── */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm)}
.card-header{padding:14px 18px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center}
.card-header h3{font-size:13px;font-weight:600;color:var(--text-primary)}
.card-body{padding:18px}

.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text-primary);font-size:13px;font-weight:500;cursor:pointer;transition:all .12s;font-family:var(--font-body);line-height:1.4}
.btn:hover{background:var(--surface-hover);border-color:#D4D4D8}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn-primary:hover{background:var(--accent-hover);border-color:var(--accent-hover)}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-danger{color:var(--red);border-color:var(--red-border)}
.btn-danger:hover{background:var(--red-light)}
.btn-ghost{border:none;background:none;color:var(--text-secondary);padding:4px 8px}
.btn-ghost:hover{color:var(--text-primary);background:var(--surface-hover)}

.tag{display:inline-flex;align-items:center;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;letter-spacing:.2px;line-height:1.6}
.tag-blue{background:var(--accent-light);color:var(--accent)}
.tag-green{background:var(--green-light);color:var(--green)}
.tag-amber{background:var(--amber-light);color:var(--amber)}
.tag-red{background:var(--red-light);color:var(--red)}
.tag-purple{background:var(--purple-light);color:var(--purple)}
.tag-gray{background:#F4F4F5;color:#71717A}
.tag-orange{background:var(--orange-light);color:var(--orange)}

.input,.select,.textarea{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;font-family:var(--font-body);background:var(--surface);color:var(--text-primary);transition:border-color .15s;outline:none}
.input:focus,.select:focus,.textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.08)}
.textarea{min-height:56px;resize:vertical;line-height:1.5}
.input::placeholder{color:var(--text-tertiary)}

.field{margin-bottom:14px}
.field>label{display:block;font-size:12px;font-weight:500;color:var(--text-secondary);margin-bottom:4px;letter-spacing:.1px}
.field .req{color:var(--red);margin-left:1px}

.search-box{position:relative}
.search-box svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-tertiary);width:15px;height:15px}
.search-box .input{padding-left:32px;background:var(--surface-hover);border-color:transparent}
.search-box .input:focus{background:var(--surface);border-color:var(--accent)}

table{width:100%;border-collapse:collapse}
thead th{padding:8px 14px;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border);text-align:left;background:transparent}
tbody td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--border-light);color:var(--text-primary);vertical-align:middle}
tbody tr{transition:background .1s}
tbody tr.clickable{cursor:pointer}
tbody tr.clickable:hover{background:var(--surface-hover)}

/* ─── Metric cards ─── */
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.metric{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px 18px}
.metric-label{font-size:12px;color:var(--text-tertiary);font-weight:500;margin-bottom:8px}
.metric-value{font-family:var(--font-display);font-size:24px;font-weight:700;color:var(--text-primary);letter-spacing:-.5px;line-height:1}
.metric-sub{font-size:11px;color:var(--text-tertiary);margin-top:4px}

/* ─── Progress ─── */
.progress{height:6px;background:var(--border-light);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;border-radius:3px;transition:width .6s ease}

/* ─── Utilities ─── */
.flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-between{justify-content:space-between}
.gap-2{gap:8px}.gap-3{gap:12px}.gap-4{gap:16px}.gap-6{gap:24px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.text-secondary{color:var(--text-secondary)}.text-accent{color:var(--accent)}.text-sm{font-size:12px}.text-xs{font-size:11px}
.font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}
.mt-1{margin-top:4px}.mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}.mt-6{margin-top:24px}
.mb-2{margin-bottom:8px}.mb-3{margin-bottom:12px}.mb-4{margin-bottom:16px}.mb-6{margin-bottom:24px}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mono{font-family:var(--font-mono);font-size:12px;letter-spacing:-.2px}
.divider{border-top:1px solid var(--border-light);margin:16px 0}
.back-link{display:inline-flex;align-items:center;gap:4px;font-size:13px;font-weight:500;color:var(--text-secondary);cursor:pointer;border:none;background:none;padding:0;margin-bottom:16px;font-family:var(--font-body);transition:color .12s}
.back-link:hover{color:var(--accent)}
.empty{padding:32px;text-align:center;color:var(--text-tertiary);font-size:13px}
.loading{display:flex;align-items:center;justify-content:center;padding:60px}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.toast{position:fixed;bottom:20px;right:20px;padding:10px 16px;border-radius:var(--radius);font-size:13px;font-weight:500;z-index:9999;animation:slideUp .25s ease;box-shadow:var(--shadow-md)}
.toast-ok{background:#065F46;color:#fff}.toast-err{background:var(--red);color:#fff}
@keyframes slideUp{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}

.config-banner{background:var(--amber-light);border:1px solid var(--amber-border);border-radius:var(--radius-lg);padding:16px 20px;margin-bottom:20px}
.config-banner h3{font-size:14px;font-weight:600;color:#92400E;margin-bottom:4px}
.config-banner p{font-size:13px;color:#92400E}

/* ─── Checkbox group ─── */
.check-group{display:flex;flex-wrap:wrap;gap:6px}
.check-group label{display:flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:500;transition:all .12s;user-select:none;color:var(--text-secondary)}
.check-group label:has(input:checked){background:var(--accent);color:#fff;border-color:var(--accent)}
.check-group label input{display:none}

/* ─── Filter tags ─── */
.filter-tag{display:inline-flex;align-items:center;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;transition:all .12s;border:1px solid var(--border);color:var(--text-secondary);user-select:none}
.filter-tag.active{background:var(--text-primary);color:#fff;border-color:var(--text-primary)}
.filter-tag:hover{border-color:var(--text-tertiary)}

/* ─── Attachment area ─── */
.drop-zone{border:1.5px dashed var(--border);border-radius:var(--radius-lg);padding:20px;text-align:center;cursor:pointer;transition:all .15s;background:var(--surface-hover)}
.drop-zone:hover,.drop-zone.drag{border-color:var(--accent);background:var(--accent-light)}
.att-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border-light);border-radius:var(--radius);margin-top:8px;transition:background .1s}
.att-row:hover{background:var(--surface-hover)}
.att-type{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;letter-spacing:.5px;flex-shrink:0}
.att-type.pdf{background:var(--red-light);color:var(--red)}.att-type.doc{background:var(--accent-light);color:var(--accent)}.att-type.img{background:var(--green-light);color:var(--green)}.att-type.other{background:#F4F4F5;color:#71717A}

/* ─── Tabs ─── */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:20px}
.tab{padding:8px 16px;font-size:13px;font-weight:500;color:var(--text-tertiary);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .12s;font-family:var(--font-body);background:none;border-top:none;border-left:none;border-right:none}
.tab.active{color:var(--text-primary);border-bottom-color:var(--text-primary)}
.tab:hover{color:var(--text-secondary)}

/* ─── Team bars ─── */
.team-bar{height:28px;border-radius:4px;display:flex;align-items:center;padding:0 10px;font-size:12px;font-weight:600;color:#fff;min-width:32px;transition:width .5s ease}
.team-a{background:var(--accent)}.team-b{background:var(--amber)}

/* ─── Urban renewal panel ─── */
.urban-panel{background:var(--orange-light);border:1px solid var(--orange-border);border-radius:var(--radius-lg);padding:14px 18px;margin-bottom:14px}
.urban-panel .section-title{color:var(--orange)}

/* ─── Fee calculation ─── */
.fee-calc{background:var(--surface-hover);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px 18px;margin-bottom:16px}
.fee-amount{font-family:var(--font-display);font-size:20px;font-weight:700;color:var(--accent);letter-spacing:-.3px}
.fee-strike{text-decoration:line-through;color:var(--text-tertiary);font-size:13px;margin-left:6px}

/* ─── Company selector ─── */
.co-screen{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:var(--sidebar-bg)}
.co-screen h1{font-family:var(--font-display);font-size:28px;font-weight:700;color:#FAFAFA;text-align:center;letter-spacing:.5px;margin-bottom:4px}
.co-screen p{text-align:center;color:#71717A;font-size:13px;margin-bottom:36px}
.co-cards{display:flex;gap:16px}
.co-card{width:200px;padding:28px 24px;border-radius:var(--radius-lg);cursor:pointer;border:1px solid #27272A;background:#27272A;text-align:center;transition:all .2s}
.co-card:hover{border-color:#52525B;background:#3F3F46;transform:translateY(-2px)}
.co-card .co-emoji{font-size:28px;margin-bottom:10px}
.co-card h2{font-family:var(--font-display);font-size:16px;font-weight:700;color:#FAFAFA;margin-bottom:4px}
.co-card p{font-size:12px;color:#71717A;margin-bottom:0}

.actions{display:flex;justify-content:flex-end;gap:8px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border-light)}
</style>
</head>
<body>
<div id="root"></div>
<script>
// ═══════════════════════════════════════════════════════════
// 宇豐案件管理系統 v5 — Professional Redesign
// ═══════════════════════════════════════════════════════════
let SUPABASE_URL=localStorage.getItem('yf_sb_url')||'',SUPABASE_KEY=localStorage.getItem('yf_sb_key')||'',sb=null;
function initSB(){if(SUPABASE_URL&&SUPABASE_KEY){sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);return true;}return false;}
initSB();

const COMPANIES=['宇豐估價','宇豐顧問'],APPRAISERS=['所長','副所','博宇','慈妮'];
const CASE_TYPES=['土地估價','建物估價','都市更新','權利變換','聯合貸款','法拍鑑價','資產重估','租金評估','其他'];
const CASE_STATUS=['洽談中','已簽約','進行中','已出報告','已結案','暫停'];
const PAY_STATUS=['未請款','已請款','已收款','逾期'];
const GIFT_TYPES=['中秋節','年節禮','桌曆/年曆','端午節','其他'];
let curCompany=localStorage.getItem('yf_company')||'';
function selectCompany(c){curCompany=c;localStorage.setItem('yf_company',c);document.getElementById('root').innerHTML='<div id="app" class="app"></div>';render();loadData();}

const TEAMS={'文組':{members:[]},'妮組':{members:[]}};
function loadTeams(){const s=localStorage.getItem('yf_teams');if(s)try{const d=JSON.parse(s);TEAMS['文組'].members=d['文組']||[];TEAMS['妮組'].members=d['妮組']||[];}catch(e){}}
function saveTeams(){localStorage.setItem('yf_teams',JSON.stringify({'文組':TEAMS['文組'].members,'妮組':TEAMS['妮組'].members}));}
loadTeams();
function getTeamOf(h){if(!h)return null;if(TEAMS['文組'].members.includes(h))return'文組';if(TEAMS['妮組'].members.includes(h))return'妮組';return null;}
function toggleTeamMember(t,h,ck){const o=t==='文組'?'妮組':'文組';if(ck){TEAMS[o].members=TEAMS[o].members.filter(m=>m!==h);if(!TEAMS[t].members.includes(h))TEAMS[t].members.push(h);}else TEAMS[t].members=TEAMS[t].members.filter(m=>m!==h);saveTeams();render();}

let S={page:'dashboard',sub:null,customers:[],cases:[],loading:false,selCust:null,selCase:null,search:'',fStatus:'全部',fApp:'全部',giftFilter:[],attachments:[],analyticsTab:'overview'};

// ─── SVG Icons (minimal, consistent stroke) ────────────────
const IC={
  home:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V9.5z"/><path d="M9 21V12h6v9"/></svg>',
  users:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>',
  folder:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>',
  dollar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
  search:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  plus:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  edit:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
  back:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>',
  trash:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>',
  gift:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>',
  upload:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/></svg>',
  download:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  file:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  team:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/><circle cx="19" cy="7" r="3"/><path d="M21 21v-1a3 3 0 00-2-2.8"/></svg>',
  chart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
  swap:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="7 16 3 12 7 8"/><polyline points="17 8 21 12 17 16"/><line x1="3" y1="12" x2="21" y2="12"/></svg>',
  clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
};
function icon(name,size=15){return`<svg style="width:${size}px;height:${size}px;display:inline-block;vertical-align:middle;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">${IC[name]?.replace(/<\/?svg[^>]*>/g,'')||''}</svg>`;}

// ─── Helpers ───────────────────────────────────────────────
const fmt=n=>n?'$'+Number(n).toLocaleString():'-';
const statusTag=s=>{const m={洽談中:'purple',已簽約:'blue',進行中:'amber',已出報告:'green',已結案:'gray',暫停:'red'};return`<span class="tag tag-${m[s]||'gray'}">${s}</span>`;};
const payTag=s=>{const m={未請款:'gray',已請款:'amber',已收款:'green',逾期:'red'};return`<span class="tag tag-${m[s]||'gray'}">${s}</span>`;};
const appDisplay=a=>{if(!a)return'-';const arr=Array.isArray(a)?a:[a];return arr.filter(Boolean).join('、')||'-';};
const caseType=c=>c.type==='其他'&&c.custom_type?c.custom_type:(c.type||'-');
const fileIcon=n=>{const e=(n||'').split('.').pop().toLowerCase();if(e==='pdf')return'pdf';if(['doc','docx'].includes(e))return'doc';if(['jpg','jpeg','png','gif','webp'].includes(e))return'img';return'other';};
const fileSize=b=>{if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';};
function matchSearch(t,...f){if(!t)return true;const l=t.toLowerCase();return f.some(v=>{if(!v)return false;if(Array.isArray(v))return v.some(x=>String(x).toLowerCase().includes(l));return String(v).toLowerCase().includes(l);});}
function searchHtml(ph){return`<div class="search-box" style="flex:1">${icon('search')}<input class="input search-inp" placeholder="${ph}" value="${S.search}"></div>`;}

let toastT;function toast(m,ok=true){document.querySelectorAll('.toast').forEach(e=>e.remove());const el=document.createElement('div');el.className=`toast toast-${ok?'ok':'err'}`;el.textContent=m;document.body.appendChild(el);clearTimeout(toastT);toastT=setTimeout(()=>el.remove(),3000);}
function nav(p,sub=null){S.page=p;S.sub=sub;S.selCust=null;S.selCase=null;S.search='';S.fStatus='全部';S.fApp='全部';S.giftFilter=[];S.attachments=[];S.analyticsTab='overview';render();loadData();}
let _composing=false;function bindSearch(){document.querySelectorAll('.search-inp').forEach(el=>{if(el._b)return;el._b=true;el.addEventListener('compositionstart',()=>_composing=true);el.addEventListener('compositionend',e=>{_composing=false;S.search=e.target.value;render();});el.addEventListener('input',e=>{if(!_composing){S.search=e.target.value;render();}});});}

// ─── API ───────────────────────────────────────────────────
async function loadData(){if(!sb||!curCompany)return;S.loading=true;render();try{const[cR,csR]=await Promise.all([sb.from('customers').select('*, contacts(*)').eq('company',curCompany).order('created_at',{ascending:false}),sb.from('cases').select('*, payments(*)').eq('company',curCompany).order('created_at',{ascending:false})]);if(cR.data)S.customers=cR.data.map(c=>({...c,gifts:c.gifts||[]}));if(csR.data)S.cases=csR.data.map(c=>({...c,appraiser:c.appraiser||[],contract_amount:Number(c.contract_amount)||0,paid_amount:Number(c.paid_amount)||0,leading_fee:Number(c.leading_fee)||0,discount_pct:Number(c.discount_pct)||100,payments:(c.payments||[]).map(p=>({...p,amount:Number(p.amount)||0,ratio:Number(p.ratio)||0}))}));}catch(e){toast('載入失敗: '+e.message,false);}S.loading=false;render();}
async function loadAttachments(id){if(!sb)return[];try{const{data}=await sb.from('attachments').select('*').eq('case_id',id).order('uploaded_at',{ascending:false});return data||[];}catch(e){return[];}}
async function uploadFile(cid,file,cat){if(!sb)return;try{const ext=file.name.split('.').pop().toLowerCase();const safeName=`${Date.now()}.${ext}`;const path=`${cid}/${safeName}`;const{error:ue}=await sb.storage.from('case-files').upload(path,file);if(ue)throw ue;await sb.from('attachments').insert({case_id:cid,file_name:file.name,file_type:file.name.split('.').pop(),file_size:file.size,storage_path:path,category:cat||'其他',company:curCompany});toast('上傳成功');return true;}catch(e){toast('上傳失敗: '+e.message,false);}}
async function downloadFile(a){if(!sb)return;try{const{data}=sb.storage.from('case-files').getPublicUrl(a.storage_path);if(data?.publicUrl)window.open(data.publicUrl,'_blank');}catch(e){toast('下載失敗',false);}}
async function deleteFile(a,cid){if(!sb||!confirm('確定刪除？'))return;try{await sb.storage.from('case-files').remove([a.storage_path]);await sb.from('attachments').delete().eq('id',a.id);toast('已刪除');S.attachments=await loadAttachments(cid);render();}catch(e){toast('刪除失敗',false);}}
async function genCustCode(){const{data}=await sb.from('customers').select('code').order('code',{ascending:false}).limit(1);if(data?.length>0){const n=parseInt(data[0].code.replace('YF-',''),10)+1;return'YF-'+String(n).padStart(4,'0');}return'YF-0001';}
async function genCaseCode(){const d=new Date();const pf=`${d.getFullYear()-1911}${String(d.getMonth()+1).padStart(2,'0')}`;const{data}=await sb.from('cases').select('code').like('code',pf+'%').order('code',{ascending:false}).limit(1);if(data?.length>0){const seq=parseInt(data[0].code.substr(pf.length),10)+1;return pf+String(seq).padStart(3,'0');}return pf+'001';}
async function saveCust(form){S.loading=true;render();try{const d={name:form.name,tax_id:form.taxId,phone:form.phone,fax:form.fax,address:form.address,note:form.note,gifts:form.gifts,company:curCompany};let cid;if(form.id){await sb.from('customers').update(d).eq('id',form.id);cid=form.id;await sb.from('contacts').delete().eq('customer_id',cid);}else{d.code=await genCustCode();const{data,error}=await sb.from('customers').insert(d).select().single();if(error)throw error;cid=data.id;}const cts=(form.contacts||[]).filter(c=>c.name);if(cts.length>0)await sb.from('contacts').insert(cts.map(c=>({customer_id:cid,name:c.name,ext:c.ext,mobile:c.mobile,email:c.email})));toast('已儲存');await loadData();S.selCust=S.customers.find(c=>c.id===cid);S.page='customers';S.sub='detail';}catch(e){toast('儲存失敗: '+e.message,false);}S.loading=false;render();}
async function saveCs(form){S.loading=true;render();try{const d={customer_id:form.customerId||null,customer_name:form.customerName,type:form.type,custom_type:form.customType||'',subject:form.subject,address:form.address,appraiser:form.appraiser||[],handler:form.handler,status:form.status,contract_amount:Number(form.contractAmount)||0,sign_date:form.signDate||null,due_date:form.dueDate||null,note:form.note,company:curCompany,is_leading:form.isLeading||false,leading_fee:Number(form.leadingFee)||0,leading_fee_period:Number(form.leadingFeePeriod)||1,discount_pct:Number(form.discountPct)||100};let cid;if(form.id){await sb.from('cases').update(d).eq('id',form.id);cid=form.id;}else{d.code=await genCaseCode();const{data,error}=await sb.from('cases').insert(d).select().single();if(error)throw error;cid=data.id;if(form.payments?.length>0)await sb.from('payments').insert(form.payments.map(p=>({case_id:cid,period:p.period,ratio:p.ratio,amount:p.amount,status:p.status||'未請款',due_date:p.dueDate||null,paid_date:p.paidDate||null})));}toast('已儲存');await loadData();S.selCase=S.cases.find(c=>c.id===cid);S.page='cases';S.sub='detail';}catch(e){toast('儲存失敗: '+e.message,false);}S.loading=false;render();}
async function updatePay(pid,cid,st){const pd=st==='已收款'?new Date().toISOString().split('T')[0]:null;await sb.from('payments').update({status:st,paid_date:pd}).eq('id',pid);toast('已更新');await loadData();S.selCase=S.cases.find(c=>c.id===cid);render();}

// ─── Sidebar ───────────────────────────────────────────────
function rSide(){const d=new Date();const tw=`${d.getFullYear()-1911}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;const a=(p,s)=>S.page===p&&(s?S.sub===s:!S.sub)?'active':'';const other=curCompany==='宇豐估價'?'宇豐顧問':'宇豐估價';
return`<div class="sidebar"><div class="s-head"><h1>${curCompany}</h1><p>案件管理系統</p><div class="s-switch" onclick="selectCompany('${other}')">${icon('swap',12)} 切換至${other}</div></div><div class="s-nav">
<div class="s-item ${a('dashboard')}" onclick="nav('dashboard')">${icon('home')} 總覽</div>
<div class="s-section">客戶</div>
<div class="s-item ${a('customers','create')}" onclick="nav('customers','create')">${icon('plus')} 新增客戶</div>
<div class="s-item ${a('customers','list')||a('customers','detail')?'active':''}" onclick="nav('customers','list')">${icon('users')} 客戶查詢</div>
<div class="s-item ${a('customers','gifts')?'active':''}" onclick="nav('customers','gifts')">${icon('gift')} 送禮篩選</div>
<div class="s-section">案件</div>
<div class="s-item ${a('cases','create')}" onclick="nav('cases','create')">${icon('plus')} 新增案件</div>
<div class="s-item ${a('cases','list')||a('cases','detail')?'active':''}" onclick="nav('cases','list')">${icon('folder')} 案件查詢</div>
<div class="s-section">財務</div>
<div class="s-item ${a('payments','track')}" onclick="nav('payments','track')">${icon('dollar')} 款項追蹤</div>
<div class="s-item ${a('analytics','revenue')}" onclick="nav('analytics','revenue')">${icon('chart')} 收款統計</div>
<div class="s-section">團隊</div>
<div class="s-item ${a('analytics','handler')}" onclick="nav('analytics','handler')">${icon('team')} 承辦報表</div>
</div><div class="s-foot">${tw}</div></div>`;}

function rCfg(){if(sb)return'';return`<div class="config-banner"><h3>需要設定 Supabase 連線</h3><p>前往 Supabase → Settings → API 取得連線資訊</p><div class="field mt-3"><label>Project URL</label><input class="input" id="cfgU" placeholder="https://xxxxx.supabase.co" style="max-width:480px;font-family:var(--font-mono)"></div><div class="field"><label>anon public Key</label><input class="input" id="cfgK" placeholder="eyJhbGci..." style="max-width:480px;font-family:var(--font-mono)"></div><button class="btn btn-primary mt-2" onclick="saveCfg()">連接</button></div>`;}
function saveCfg(){const u=document.getElementById('cfgU')?.value?.trim(),k=document.getElementById('cfgK')?.value?.trim();if(u&&k){SUPABASE_URL=u;SUPABASE_KEY=k;localStorage.setItem('yf_sb_url',u);localStorage.setItem('yf_sb_key',k);if(initSB()){toast('連線成功');loadData();}}else toast('請填寫完整',false);}

// ─── Dashboard ─────────────────────────────────────────────
function rDash(){const cs=S.cases,cu=S.customers;const active=cs.filter(c=>['進行中','已簽約','洽談中'].includes(c.status)).length;const rev=cs.reduce((s,c)=>s+(c.contract_amount||0),0);const col=cs.reduce((s,c)=>s+(c.paid_amount||0),0);const allP=cs.flatMap(c=>c.payments||[]);const pend=allP.filter(p=>p.status==='已請款').length;const over=allP.filter(p=>p.status==='逾期').length;const recent=cs.slice(0,6);const handlers={};cs.forEach(c=>{if(c.handler){if(!handlers[c.handler])handlers[c.handler]={name:c.handler,n:0,rev:0,active:0};handlers[c.handler].n++;handlers[c.handler].rev+=c.contract_amount||0;if(['進行中','已簽約'].includes(c.status))handlers[c.handler].active++;}});const hList=Object.values(handlers).sort((a,b)=>b.rev-a.rev);
return`<div class="flex items-center justify-between mb-6"><h1 class="page-title">總覽</h1><span class="tag tag-${curCompany==='宇豐估價'?'blue':'orange'}">${curCompany}</span></div>${rCfg()}
<div class="metrics"><div class="metric"><div class="metric-label">進行中</div><div class="metric-value">${active}</div><div class="metric-sub">共 ${cs.length} 件</div></div><div class="metric"><div class="metric-label">合約總額</div><div class="metric-value">${fmt(rev)}</div><div class="metric-sub">已收 ${fmt(col)}</div></div><div class="metric"><div class="metric-label">客戶數</div><div class="metric-value">${cu.length}</div></div><div class="metric"><div class="metric-label">待收款項</div><div class="metric-value">${pend}</div><div class="metric-sub">${over>0?over+' 筆逾期':'無逾期'}</div></div></div>
<div class="grid-2"><div class="card"><div class="card-header"><h3>近期案件</h3></div>${recent.length===0?'<div class="empty">尚無案件</div>':recent.map(c=>`<div style="padding:10px 18px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .1s" onmouseover="this.style.background='var(--surface-hover)'" onmouseout="this.style.background=''" onclick="viewCase('${c.id}')"><div style="min-width:0"><div class="font-medium truncate" style="font-size:13px">${c.subject||'-'}${c.is_leading?' <span class="tag tag-orange">領銜</span>':''}</div><div class="text-xs text-secondary mt-1"><span class="mono">${c.code}</span> · ${c.customer_name||'-'}</div></div>${statusTag(c.status)}</div>`).join('')}</div>
<div class="card"><div class="card-header"><h3>承辦統計</h3></div>${hList.length===0?'<div class="empty">尚無資料</div>':hList.map(a=>{const t=getTeamOf(a.name);return`<div style="padding:10px 18px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center"><div><span class="font-medium" style="font-size:13px">${a.name}</span>${t?` <span class="tag tag-${t==='文組'?'blue':'amber'}" style="font-size:10px">${t}</span>`:''}<div class="text-xs text-secondary mt-1">${a.active} 件進行中 · 共 ${a.n} 件</div></div><span class="font-semibold text-sm">${fmt(a.rev)}</span></div>`;}).join('')}</div></div>`;
}

// ─── Gift Filter ───────────────────────────────────────────
function rGifts(){const t=S.search.toLowerCase();const f=S.customers.filter(c=>{const ms=matchSearch(t,c.name,c.code,c.tax_id,(c.contacts||[]).map(x=>x.name));const mg=S.giftFilter.length===0||S.giftFilter.every(g=>(c.gifts||[]).includes(g));return ms&&mg;});
return`<h1 class="page-title mb-4">送禮篩選</h1><div class="card mb-4" style="padding:16px 18px"><div class="flex items-center gap-2 mb-3"><span class="section-title">篩選類型</span></div><div class="flex gap-2" style="flex-wrap:wrap">${GIFT_TYPES.map(g=>`<span class="filter-tag ${S.giftFilter.includes(g)?'active':''}" onclick="toggleGift('${g}')">${g}</span>`).join('')}</div>${S.giftFilter.length>0?`<div class="text-sm text-secondary mt-3">篩選結果：${f.length} 位客戶</div>`:''}</div>
<div class="flex gap-3 mb-4">${searchHtml('搜尋客戶...')}</div>
<div class="card"><table><thead><tr><th>編號</th><th>客戶名稱</th><th>電話</th><th>聯絡窗口</th><th>送禮項目</th></tr></thead><tbody>${f.map(c=>`<tr class="clickable" onclick="viewCust('${c.id}')"><td class="mono text-accent">${c.code}</td><td class="font-medium">${c.name}</td><td>${c.phone||'-'}</td><td class="text-secondary">${(c.contacts||[]).map(x=>x.name).join('、')||'-'}</td><td>${(c.gifts||[]).map(g=>`<span class="tag tag-blue" style="margin:1px 2px">${g}</span>`).join('')||'-'}</td></tr>`).join('')}</tbody></table>${f.length===0?'<div class="empty">查無資料</div>':''}</div>`;}
function toggleGift(g){if(S.giftFilter.includes(g))S.giftFilter=S.giftFilter.filter(x=>x!==g);else S.giftFilter.push(g);render();}

// ─── Customer List / Detail / Form ─────────────────────────
function rCustList(){const f=S.customers.filter(c=>matchSearch(S.search,c.name,c.code,c.tax_id,(c.contacts||[]).map(x=>x.name)));return`<div class="flex items-center justify-between mb-4"><h1 class="page-title">客戶查詢</h1><button class="btn btn-primary" onclick="nav('customers','create')">${icon('plus',14)} 新增客戶</button></div><div class="flex gap-3 mb-4">${searchHtml('搜尋客戶名稱、編號、統編...')}</div><div class="card"><table><thead><tr><th>編號</th><th>客戶名稱</th><th>統編</th><th>電話</th><th>聯絡窗口</th><th>案件</th></tr></thead><tbody>${f.map(c=>{const n=S.cases.filter(x=>x.customer_id===c.id).length;return`<tr class="clickable" onclick="viewCust('${c.id}')"><td class="mono text-accent">${c.code}</td><td class="font-medium">${c.name}</td><td class="text-secondary">${c.tax_id||'-'}</td><td>${c.phone||'-'}</td><td class="text-secondary">${(c.contacts||[]).map(x=>x.name).join('、')||'-'}</td><td><span class="tag tag-${n>0?'blue':'gray'}">${n}</span></td></tr>`;}).join('')}</tbody></table>${f.length===0?'<div class="empty">查無資料</div>':''}</div>`;}

function rCustDet(){const c=S.selCust;if(!c)return'<div class="empty">找不到</div>';const rc=S.cases.filter(x=>x.customer_id===c.id);return`<button class="back-link" onclick="nav('customers','list')">${icon('back',14)} 返回</button><div class="card mb-4"><div class="card-body"><div class="flex items-center justify-between mb-4"><div><div class="mono text-accent text-xs mb-1">${c.code}</div><h2 class="page-title">${c.name}</h2></div><button class="btn btn-sm" onclick="editCust('${c.id}')">${icon('edit',13)} 編輯</button></div><div class="grid-3" style="font-size:13px"><div><span class="text-secondary">統編</span><div class="mt-1">${c.tax_id||'-'}</div></div><div><span class="text-secondary">電話</span><div class="mt-1">${c.phone||'-'}</div></div><div><span class="text-secondary">傳真</span><div class="mt-1">${c.fax||'-'}</div></div><div style="grid-column:1/-1"><span class="text-secondary">地址</span><div class="mt-1">${c.address||'-'}</div></div>${c.note?`<div style="grid-column:1/-1"><span class="text-secondary">備註</span><div class="mt-1">${c.note}</div></div>`:''}</div>
${(c.contacts||[]).length>0?`<div class="divider"></div><div class="section-title mb-3">聯絡窗口</div>${c.contacts.map(ct=>`<div class="flex items-center gap-3" style="padding:4px 0;font-size:13px"><span class="font-medium">${ct.name}</span>${ct.ext?`<span class="text-secondary">分機 ${ct.ext}</span>`:''}${ct.mobile?`<span>${ct.mobile}</span>`:''}${ct.email?`<span class="text-accent">${ct.email}</span>`:''}</div>`).join('')}`:''}
${(c.gifts||[]).length>0?`<div class="flex items-center gap-2 mt-3"><span class="text-xs text-secondary">送禮：</span>${c.gifts.map(g=>`<span class="tag tag-blue">${g}</span>`).join('')}</div>`:''}</div></div>
<div class="card"><div class="card-header"><h3>相關案件 (${rc.length})</h3><button class="btn btn-primary btn-sm" onclick="nav('cases','create')">${icon('plus',13)} 新增</button></div>${rc.length===0?'<div class="empty">尚無案件</div>':`<table><thead><tr><th>編號</th><th>標的</th><th>類型</th><th>估價師</th><th>金額</th><th>狀態</th></tr></thead><tbody>${rc.map(x=>`<tr class="clickable" onclick="viewCase('${x.id}')"><td class="mono text-accent">${x.code}</td><td class="font-medium">${x.subject||'-'}${x.is_leading?' <span class="tag tag-orange">領銜</span>':''}</td><td><span class="tag tag-blue">${caseType(x)}</span></td><td class="text-secondary">${appDisplay(x.appraiser)}</td><td class="font-semibold">${fmt(x.contract_amount)}</td><td>${statusTag(x.status)}</td></tr>`).join('')}</tbody></table>`}</div>`;}

function rCustForm(data){const f=data||{code:'自動生成',name:'',tax_id:'',phone:'',fax:'',address:'',note:'',contacts:[{name:'',ext:'',mobile:'',email:''}],gifts:[]};return`<h1 class="page-title mb-4">${data?'編輯客戶':'新增客戶'}</h1><div class="card"><div class="card-body"><div style="background:var(--accent-light);border-radius:var(--radius);padding:8px 12px;margin-bottom:16px"><span class="mono text-accent text-sm">${f.code}</span></div><form id="cf" onsubmit="submitCust(event)"><input type="hidden" name="id" value="${f.id||''}"><div class="grid-2"><div class="field"><label>委託單位 <span class="req">*</span></label><input class="input" name="name" value="${f.name}" required></div><div class="field"><label>統一編號</label><input class="input" name="taxId" value="${f.tax_id||''}"></div><div class="field"><label>電話</label><input class="input" name="phone" value="${f.phone||''}"></div><div class="field"><label>傳真</label><input class="input" name="fax" value="${f.fax||''}"></div></div><div class="field"><label>地址</label><input class="input" name="address" value="${f.address||''}"></div><div class="field"><label>備註</label><input class="input" name="note" value="${f.note||''}"></div>
<div class="divider"></div><div class="flex items-center justify-between mb-3"><span class="section-title">聯絡窗口</span><button type="button" class="btn btn-sm" onclick="addCtRow()">${icon('plus',13)} 新增</button></div><div id="ctRows">${(f.contacts||[{name:'',ext:'',mobile:'',email:''}]).map((ct,i)=>`<div class="ct-row grid-2" style="grid-template-columns:1fr 80px 1fr 1fr auto;display:grid;gap:8px;margin-bottom:8px;align-items:end"><div class="field"><label>姓名</label><input class="input" name="cn_${i}" value="${ct.name||''}"></div><div class="field"><label>分機</label><input class="input" name="ce_${i}" value="${ct.ext||''}"></div><div class="field"><label>手機</label><input class="input" name="cm_${i}" value="${ct.mobile||''}"></div><div class="field"><label>Email</label><input class="input" name="cem_${i}" value="${ct.email||''}"></div><button type="button" class="btn-ghost" onclick="this.parentElement.remove()" style="margin-bottom:14px;color:var(--red)">${icon('trash',14)}</button></div>`).join('')}</div>
<div class="divider"></div><div class="section-title mb-2">送禮紀錄</div><div class="check-group">${GIFT_TYPES.map(g=>`<label><input type="checkbox" name="gifts" value="${g}" ${(f.gifts||[]).includes(g)?'checked':''}>${g}</label>`).join('')}</div>
<div class="actions"><button type="button" class="btn" onclick="nav('customers','list')">取消</button><button type="submit" class="btn btn-primary">儲存</button></div></form></div></div>`;}
let ctN=10;function addCtRow(){const c=document.getElementById('ctRows');const i=ctN++;const d=document.createElement('div');d.className='ct-row';d.style.cssText='display:grid;grid-template-columns:1fr 80px 1fr 1fr auto;gap:8px;margin-bottom:8px;align-items:end';d.innerHTML=`<div class="field"><label>姓名</label><input class="input" name="cn_${i}"></div><div class="field"><label>分機</label><input class="input" name="ce_${i}"></div><div class="field"><label>手機</label><input class="input" name="cm_${i}"></div><div class="field"><label>Email</label><input class="input" name="cem_${i}"></div><button type="button" class="btn-ghost" onclick="this.parentElement.remove()" style="margin-bottom:14px;color:var(--red)">${icon('trash',14)}</button>`;c.appendChild(d);}
function submitCust(e){e.preventDefault();const f=e.target;const d={id:f.id.value||undefined,name:f.name.value,taxId:f.taxId.value,phone:f.phone.value,fax:f.fax.value,address:f.address.value,note:f.note.value,gifts:Array.from(f.querySelectorAll('input[name="gifts"]:checked')).map(x=>x.value),contacts:[]};f.querySelectorAll('.ct-row').forEach(r=>{const inp=r.querySelectorAll('input');if(inp[0]?.value)d.contacts.push({name:inp[0].value,ext:inp[1].value,mobile:inp[2].value,email:inp[3].value});});saveCust(d);}

// ─── Case List ─────────────────────────────────────────────
function rCaseList(){const f=S.cases.filter(c=>{const ms=matchSearch(S.search,c.subject,c.code,c.customer_name,c.appraiser,c.handler,caseType(c));const st=S.fStatus==='全部'||c.status===S.fStatus;const ap=S.fApp==='全部'||(Array.isArray(c.appraiser)?c.appraiser.includes(S.fApp):c.appraiser===S.fApp);return ms&&st&&ap;});
return`<div class="flex items-center justify-between mb-4"><h1 class="page-title">案件查詢</h1><button class="btn btn-primary" onclick="nav('cases','create')">${icon('plus',14)} 新增案件</button></div><div class="flex gap-3 mb-4">${searchHtml('搜尋案件標的、編號、客戶、承辦...')}<select class="select" style="width:auto;min-width:110px" onchange="S.fStatus=this.value;render()"><option value="全部">全部狀態</option>${CASE_STATUS.map(s=>`<option value="${s}" ${S.fStatus===s?'selected':''}>${s}</option>`).join('')}</select><select class="select" style="width:auto;min-width:120px" onchange="S.fApp=this.value;render()"><option value="全部">全部估價師</option>${APPRAISERS.map(a=>`<option value="${a}" ${S.fApp===a?'selected':''}>${a}</option>`).join('')}</select></div>
<div class="card"><table><thead><tr><th>編號</th><th>案件標的</th><th>委託單位</th><th>類型</th><th>估價師</th><th>承辦</th><th>簽約金額</th><th>狀態</th></tr></thead><tbody>${f.map(c=>`<tr class="clickable" onclick="viewCase('${c.id}')"><td class="mono text-accent">${c.code}</td><td class="font-medium">${c.subject||'-'}${c.is_leading?' <span class="tag tag-orange">領銜</span>':''}</td><td class="text-secondary">${c.customer_name||'-'}</td><td><span class="tag tag-blue">${caseType(c)}</span></td><td class="text-secondary">${appDisplay(c.appraiser)}</td><td>${c.handler||'-'}</td><td class="font-semibold">${fmt(c.contract_amount)}</td><td>${statusTag(c.status)}</td></tr>`).join('')}</tbody></table>${f.length===0?'<div class="empty">查無資料</div>':''}</div>`;}

// ─── Case Detail ───────────────────────────────────────────
function rCaseDet(){const c=S.selCase;if(!c)return'';const pm=c.payments||[];const col=pm.filter(p=>p.status==='已收款').reduce((s,p)=>s+(p.amount||0),0);const prog=c.contract_amount>0?Math.round(col/c.contract_amount*100):0;const atts=S.attachments||[];
return`<button class="back-link" onclick="nav('cases','list')">${icon('back',14)} 返回</button>
<div class="card mb-4"><div class="card-body"><div class="flex items-center justify-between mb-4"><div><div class="flex items-center gap-2 mb-2"><span class="mono text-accent text-xs">${c.code}</span>${statusTag(c.status)}<span class="tag tag-blue">${caseType(c)}</span>${c.is_leading?'<span class="tag tag-orange">領銜</span>':''}</div><h2 class="page-title">${c.subject||'-'}</h2></div><button class="btn btn-sm" onclick="editCase('${c.id}')">${icon('edit',13)} 編輯</button></div>
<div class="grid-3" style="font-size:13px;row-gap:12px"><div><span class="text-secondary">委託單位</span><div class="mt-1 font-medium text-accent" style="cursor:pointer" onclick="viewCustById('${c.customer_id}')">${c.customer_name||'-'}</div></div><div><span class="text-secondary">簽證估價師</span><div class="mt-1">${appDisplay(c.appraiser)}</div></div><div><span class="text-secondary">承辦窗口</span><div class="mt-1">${c.handler||'-'}</div></div><div style="grid-column:1/-1"><span class="text-secondary">標的地址</span><div class="mt-1">${c.address||'-'}</div></div><div><span class="text-secondary">簽約金額</span><div class="mt-1 font-semibold">${fmt(c.contract_amount)}${c.discount_pct<100?` <span class="text-secondary font-normal">(${c.discount_pct}%)</span>`:''}</div></div>${c.is_leading&&c.leading_fee>0?`<div><span class="text-secondary">領銜費</span><div class="mt-1 font-semibold">${fmt(c.leading_fee)} <span class="text-secondary font-normal">併入第 ${c.leading_fee_period} 期</span></div></div>`:''}<div><span class="text-secondary">簽約日</span><div class="mt-1">${c.sign_date||'-'}</div></div><div><span class="text-secondary">預定完成</span><div class="mt-1">${c.due_date||'-'}</div></div>${c.note?`<div style="grid-column:1/-1"><span class="text-secondary">備註</span><div class="mt-1">${c.note}</div></div>`:''}</div></div></div>

<div class="card mb-4"><div class="card-body"><div class="section-title mb-3">收款進度</div><div class="flex items-center gap-3 mb-4"><div class="progress" style="flex:1"><div class="progress-fill" style="width:${prog}%;background:${prog===100?'var(--green)':'var(--accent)'}"></div></div><span class="font-semibold text-sm" style="color:${prog===100?'var(--green)':'var(--accent)'}; white-space:nowrap">${prog}%</span><span class="text-xs text-secondary" style="white-space:nowrap">${fmt(col)} / ${fmt(c.contract_amount)}</span></div>
${pm.length>0?`<table><thead><tr><th>期數</th><th>比例</th><th>金額</th><th>期限</th><th>收款日</th><th>狀態</th><th>操作</th></tr></thead><tbody>${pm.map(p=>`<tr><td class="font-medium">第 ${p.period} 期</td><td>${p.ratio}%</td><td class="font-semibold">${fmt(p.amount)}</td><td>${p.due_date||'-'}</td><td>${p.paid_date||'-'}</td><td>${payTag(p.status)}</td><td><select class="select" style="width:auto;padding:3px 6px;font-size:12px" onchange="updatePay('${p.id}','${c.id}',this.value)">${PAY_STATUS.map(s=>`<option value="${s}" ${p.status===s?'selected':''}>${s}</option>`).join('')}</select></td></tr>`).join('')}</tbody></table>`:'<div class="empty">尚無分期</div>'}</div></div>

<div class="card"><div class="card-body"><div class="flex items-center justify-between mb-3"><span class="section-title">附件 (${atts.length})</span></div>
<div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event,'${c.id}')"><input type="file" id="fileInput" style="display:none" multiple onchange="handleFileSelect(event,'${c.id}')"><div class="text-secondary">${icon('upload',18)}</div><div class="text-sm font-medium mt-2">點擊或拖曳上傳</div><div class="text-xs text-secondary mt-1">PDF、Word、圖片等</div></div>
${atts.map(a=>`<div class="att-row"><div class="att-type ${fileIcon(a.file_name)}">${fileIcon(a.file_name).toUpperCase()}</div><div style="flex:1;min-width:0"><div class="font-medium text-sm truncate">${a.file_name}</div><div class="text-xs text-secondary mt-1">${fileSize(a.file_size)} · <span class="tag tag-blue" style="font-size:10px">${a.category}</span></div></div><button class="btn-ghost" onclick="event.stopPropagation();downloadFile(${JSON.stringify(a).replace(/"/g,'&quot;')})">${icon('download',14)}</button><button class="btn-ghost" style="color:var(--red)" onclick="event.stopPropagation();deleteFile(${JSON.stringify(a).replace(/"/g,'&quot;')},'${c.id}')">${icon('trash',14)}</button></div>`).join('')}</div></div>`;}

async function handleFileSelect(e,cid){for(const f of e.target.files)await uploadFile(cid,f,guessCategory(f.name));S.attachments=await loadAttachments(cid);render();e.target.value='';}
async function handleDrop(e,cid){e.preventDefault();document.getElementById('dropZone')?.classList.remove('drag');for(const f of e.dataTransfer?.files||[])await uploadFile(cid,f,guessCategory(f.name));S.attachments=await loadAttachments(cid);render();}
function guessCategory(n){const l=n.toLowerCase();if(l.includes('報價')||l.includes('quote'))return'報價單';if(l.includes('合約')||l.includes('contract'))return'合約';if(l.includes('估價')||l.includes('report'))return'估價報告';return'其他';}

// ─── Case Form ─────────────────────────────────────────────
function rCaseForm(data){const f=data||{code:'自動生成',customer_id:'',type:'',custom_type:'',subject:'',address:'',appraiser:[],handler:'',status:'洽談中',contract_amount:'',sign_date:'',due_date:'',note:'',is_leading:false,leading_fee:'',leading_fee_period:1,discount_pct:100};const apps=Array.isArray(f.appraiser)?f.appraiser:(f.appraiser?[f.appraiser]:[]);
return`<h1 class="page-title mb-4">${data?'編輯案件':'新增案件'}</h1><div class="card"><div class="card-body"><div style="background:var(--accent-light);border-radius:var(--radius);padding:8px 12px;margin-bottom:16px;display:flex;align-items:center;gap:8px"><span class="mono text-accent text-sm">${f.code}</span><span class="tag tag-${curCompany==='宇豐估價'?'blue':'orange'}">${curCompany}</span></div>
<form id="csf" onsubmit="submitCs(event)"><input type="hidden" name="id" value="${f.id||''}">
<div class="grid-2"><div class="field"><label>委託單位 <span class="req">*</span></label><select class="select" name="customerId" required><option value="">選擇客戶</option>${S.customers.map(c=>`<option value="${c.id}" ${f.customer_id===c.id?'selected':''}>${c.code} ${c.name}</option>`).join('')}</select></div><div class="field"><label>案件類型 <span class="req">*</span></label><select class="select" name="type" required onchange="onTypeChange(this.value)"><option value="">選擇類型</option>${CASE_TYPES.map(t=>`<option value="${t}" ${f.type===t?'selected':''}>${t}</option>`).join('')}</select></div></div>
<div class="field" id="customTypeField" style="display:${f.type==='其他'?'block':'none'}"><label>自訂類型</label><input class="input" name="customType" value="${f.custom_type||''}"></div>
<div id="urbanFields" style="display:${f.type==='都市更新'?'block':'none'}"><div class="urban-panel"><div class="section-title mb-2">都市更新設定</div><div class="flex items-center gap-4 mb-3"><label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:13px"><input type="radio" name="isLeading" value="false" ${!f.is_leading?'checked':''} onchange="onLeadingChange(false)"> 非領銜</label><label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:13px"><input type="radio" name="isLeading" value="true" ${f.is_leading?'checked':''} onchange="onLeadingChange(true)"> 領銜</label></div><div id="leadingFields" style="display:${f.is_leading?'grid':'none'}" class="grid-2"><div class="field"><label>領銜費</label><input class="input" type="number" name="leadingFee" value="${f.leading_fee||''}" oninput="recalcAll()"></div><div class="field"><label>併入期數</label><select class="select" name="leadingFeePeriod" id="lfpSel"><option value="1" ${f.leading_fee_period==1?'selected':''}>第 1 期</option><option value="2" ${f.leading_fee_period==2?'selected':''}>第 2 期</option><option value="3" ${f.leading_fee_period==3?'selected':''}>第 3 期</option></select></div></div></div></div>
<div class="grid-2"><div class="field"><label>案件標的 <span class="req">*</span></label><input class="input" name="subject" value="${f.subject||''}" required></div><div class="field"><label>標的地址</label><input class="input" name="address" value="${f.address||''}"></div></div>
<div class="field"><label>簽證估價師（可複選）</label><div class="check-group">${APPRAISERS.map(a=>`<label><input type="checkbox" name="appraiser" value="${a}" ${apps.includes(a)?'checked':''}>${a}</label>`).join('')}</div></div>
<div class="grid-2"><div class="field"><label>承辦窗口</label><input class="input" name="handler" value="${f.handler||''}"></div><div class="field"><label>狀態</label><select class="select" name="status">${CASE_STATUS.map(s=>`<option value="${s}" ${f.status===s?'selected':''}>${s}</option>`).join('')}</select></div><div class="field"><label>簽約金額（原價）</label><input class="input" type="number" name="contractAmount" value="${f.contract_amount||''}" oninput="recalcAll()"></div><div class="field"><label>簽約日期</label><input class="input" type="date" name="signDate" value="${f.sign_date||''}"></div><div class="field"><label>預定完成日</label><input class="input" type="date" name="dueDate" value="${f.due_date||''}"></div></div>
<div class="field"><label>備註</label><textarea class="textarea" name="note">${f.note||''}</textarea></div>
${!data?`<div class="divider"></div><div class="section-title mb-3">費用與分期</div>
<div class="fee-calc"><div class="flex items-center gap-3 mb-2"><span class="label" style="min-width:60px">折扣</span><input class="input" type="number" name="discountPct" value="${f.discount_pct||100}" min="1" max="100" style="width:70px;text-align:center" oninput="recalcAll()"><span class="text-sm">%</span><div class="flex gap-2">${[100,95,90,85,80].map(v=>`<span class="filter-tag" style="font-size:11px;padding:2px 8px;cursor:pointer" onclick="document.querySelector('input[name=discountPct]').value=${v};recalcAll()">${v}%</span>`).join('')}</div></div><div id="feeCalcDisplay" class="flex items-center gap-3"></div></div>
<div class="flex items-center justify-between mb-3"><span class="text-sm text-secondary">設定分期比例，可手動輸入或平均分配</span><div class="flex gap-2"><select class="select" style="width:auto" id="pmCnt" onchange="genPm()"><option value="1">1 期</option><option value="2">2 期</option><option value="3" selected>3 期</option><option value="4">4 期</option><option value="5">5 期</option></select><button type="button" class="btn btn-sm" onclick="autoEqualPm()">平均分配</button></div></div>
<div id="pmRows"></div><div id="pmTotal" class="text-sm mt-2"></div>`:''}\n<div class="actions"><button type="button" class="btn" onclick="nav('cases','list')">取消</button><button type="submit" class="btn btn-primary">儲存</button></div></form></div></div>`;}

function onTypeChange(v){document.getElementById('customTypeField').style.display=v==='其他'?'block':'none';document.getElementById('urbanFields').style.display=v==='都市更新'?'block':'none';if(v!=='都市更新'){document.querySelector('input[name="isLeading"][value="false"]').checked=true;onLeadingChange(false);}recalcAll();}
function onLeadingChange(b){document.getElementById('leadingFields').style.display=b?'grid':'none';recalcAll();}
function getCalcAmounts(){const raw=parseFloat(document.querySelector('input[name="contractAmount"]')?.value)||0;const disc=parseFloat(document.querySelector('input[name="discountPct"]')?.value)||100;const discounted=Math.round(raw*disc/100);const isL=document.querySelector('input[name="isLeading"][value="true"]')?.checked||false;const lf=isL?(parseFloat(document.querySelector('input[name="leadingFee"]')?.value)||0):0;const lp=parseInt(document.querySelector('select[name="leadingFeePeriod"]')?.value)||1;return{raw,disc,discounted,isL,lf,lp,total:discounted+lf};}
function recalcAll(){const a=getCalcAmounts();const el=document.getElementById('feeCalcDisplay');if(el){let h=`<span class="label" style="min-width:60px">實收</span><span class="fee-amount">${fmt(a.discounted)}</span>`;if(a.disc<100)h+=`<span class="fee-strike">${fmt(a.raw)}</span>`;if(a.lf>0)h+=`<span class="label" style="margin-left:12px">+ 領銜費</span><span class="fee-amount">${fmt(a.lf)}</span><span class="label" style="margin-left:12px">合計</span><span class="fee-amount" style="font-size:22px">${fmt(a.total)}</span>`;el.innerHTML=h;}
document.querySelectorAll('.pm-row').forEach((r,i)=>{const rt=parseFloat(r.querySelector('.pm-ratio')?.value)||0;if(rt>0){let am=Math.round(a.discounted*rt/100);if(a.lf>0&&(i+1)===a.lp)am+=a.lf;r.querySelector('.pm-amount').value=am;}});updatePmTotal();
const cnt=parseInt(document.getElementById('pmCnt')?.value)||3;const sel=document.getElementById('lfpSel');if(sel){const cur=parseInt(sel.value)||1;sel.innerHTML='';for(let i=1;i<=cnt;i++)sel.innerHTML+=`<option value="${i}" ${cur===i?'selected':''}>第 ${i} 期</option>`;}}
function genPm(){const cnt=parseInt(document.getElementById('pmCnt').value);document.getElementById('pmRows').innerHTML='';for(let i=0;i<cnt;i++)document.getElementById('pmRows').innerHTML+=pmRowHtml(i+1,'','','','未請款');recalcAll();}
function autoEqualPm(){const cnt=parseInt(document.getElementById('pmCnt').value);const a=getCalcAmounts();const t=a.discounted;const br=Math.floor(100/cnt);document.getElementById('pmRows').innerHTML='';for(let i=0;i<cnt;i++){const rt=i===cnt-1?100-br*(cnt-1):br;let am=i===cnt-1?t-Math.floor(t*br/100)*(cnt-1):Math.floor(t*br/100);if(a.lf>0&&(i+1)===a.lp)am+=a.lf;document.getElementById('pmRows').innerHTML+=pmRowHtml(i+1,rt,am,'','未請款');}updatePmTotal();}
function pmRowHtml(p,r,am,dd,st){return`<div class="pm-row" style="display:grid;grid-template-columns:50px 80px 130px 130px 110px;gap:8px;margin-bottom:6px;align-items:end"><div class="field"><label>第${p}期</label><input class="input" value="${p}" readonly style="text-align:center;font-weight:600;background:var(--surface-hover)"></div><div class="field"><label>比例%</label><input class="input pm-ratio" type="number" min="0" max="100" value="${r}" oninput="onRatioChange(this)"></div><div class="field"><label>金額</label><input class="input pm-amount" type="number" value="${am}" oninput="onAmountChange(this)"></div><div class="field"><label>期限</label><input class="input pm-due" type="date" value="${dd}"></div><div class="field"><label>狀態</label><select class="select pm-status">${PAY_STATUS.map(s=>`<option value="${s}" ${st===s?'selected':''}>${s}</option>`).join('')}</select></div></div>`;}
function onRatioChange(el){const a=getCalcAmounts();const rt=parseFloat(el.value)||0;const row=el.closest('.pm-row');const idx=[...document.querySelectorAll('.pm-row')].indexOf(row);let am=Math.round(a.discounted*rt/100);if(a.lf>0&&(idx+1)===a.lp)am+=a.lf;row.querySelector('.pm-amount').value=am;updatePmTotal();}
function onAmountChange(el){const a=getCalcAmounts();const am=parseFloat(el.value)||0;const row=el.closest('.pm-row');const idx=[...document.querySelectorAll('.pm-row')].indexOf(row);let base=am;if(a.lf>0&&(idx+1)===a.lp)base-=a.lf;if(a.discounted>0)row.querySelector('.pm-ratio').value=Math.round(base/a.discounted*10000)/100;updatePmTotal();}
function updatePmTotal(){const el=document.getElementById('pmTotal');if(!el)return;let tR=0,tA=0;document.querySelectorAll('.pm-row').forEach(r=>{tR+=parseFloat(r.querySelector('.pm-ratio')?.value)||0;tA+=parseFloat(r.querySelector('.pm-amount')?.value)||0;});const a=getCalcAmounts();const ok=Math.abs(tR-100)<0.01;el.innerHTML=`<span style="color:${ok?'var(--green)':'var(--red)'}">比例 ${tR}% ${ok?'✓':'（須 100%）'}</span> <span class="text-secondary" style="margin-left:12px">金額 ${fmt(tA)} / ${fmt(a.total)}</span>`;}
function submitCs(e){e.preventDefault();const f=e.target;const cust=S.customers.find(c=>c.id===f.customerId.value);const isL=f.querySelector('input[name="isLeading"][value="true"]')?.checked||false;const d={id:f.id.value||undefined,customerId:f.customerId.value,customerName:cust?cust.name:'',type:f.type.value,customType:f.customType?.value||'',subject:f.subject.value,address:f.address.value,appraiser:Array.from(f.querySelectorAll('input[name="appraiser"]:checked')).map(x=>x.value),handler:f.handler.value,status:f.status.value,contractAmount:Number(f.contractAmount.value)||0,signDate:f.signDate.value,dueDate:f.dueDate.value,note:f.note.value,isLeading:isL,leadingFee:isL?Number(f.leadingFee?.value)||0:0,leadingFeePeriod:parseInt(f.leadingFeePeriod?.value)||1,discountPct:Number(f.discountPct?.value)||100,payments:[]};document.querySelectorAll('.pm-row').forEach((row,i)=>{const rt=parseFloat(row.querySelector('.pm-ratio')?.value)||0;const am=parseFloat(row.querySelector('.pm-amount')?.value)||0;const dd=row.querySelector('.pm-due')?.value||'';const st=row.querySelector('.pm-status')?.value||'未請款';if(rt>0||am>0)d.payments.push({period:i+1,ratio:rt,amount:am,status:st,dueDate:dd,paidDate:''});});saveCs(d);}

// ─── Payments ──────────────────────────────────────────────
function rPay(){const all=S.cases.flatMap(c=>(c.payments||[]).map(p=>({...p,cCode:c.code,cSubj:c.subject,cName:c.customer_name,caseId:c.id,handler:c.handler})));const f=all.filter(p=>{const ms=matchSearch(S.search,p.cSubj,p.cCode,p.cName,p.handler);const st=S.fStatus==='全部'||p.status===S.fStatus;return ms&&st;});const sums=PAY_STATUS.map(s=>({s,n:all.filter(p=>p.status===s).length,t:all.filter(p=>p.status===s).reduce((a,p)=>a+(p.amount||0),0)}));
return`<h1 class="page-title mb-4">款項追蹤</h1><div class="flex gap-3 mb-4">${searchHtml('搜尋案件、客戶、承辦...')}<select class="select" style="width:auto" onchange="S.fStatus=this.value;render()"><option value="全部">全部狀態</option>${PAY_STATUS.map(s=>`<option value="${s}" ${S.fStatus===s?'selected':''}>${s}</option>`).join('')}</select></div>
<div class="metrics" style="grid-template-columns:repeat(4,1fr)">${sums.map(x=>`<div class="metric">${payTag(x.s)}<div class="metric-value mt-2">${x.n}</div><div class="metric-sub">${fmt(x.t)}</div></div>`).join('')}</div>
<div class="card"><table><thead><tr><th>編號</th><th>標的</th><th>客戶</th><th>期數</th><th>金額</th><th>期限</th><th>狀態</th></tr></thead><tbody>${f.map(p=>`<tr class="clickable" onclick="viewCase('${p.caseId}')"><td class="mono text-accent">${p.cCode}</td><td>${p.cSubj||'-'}</td><td class="text-secondary">${p.cName||'-'}</td><td>第 ${p.period} 期</td><td class="font-semibold">${fmt(p.amount)}</td><td>${p.due_date||'-'}</td><td>${payTag(p.status)}</td></tr>`).join('')}</tbody></table>${f.length===0?'<div class="empty">查無款項</div>':''}</div>`;}

// ─── Analytics ─────────────────────────────────────────────
function rAnalytics(type){
if(type==='revenue'){const byT=CASE_TYPES.map(t=>{const c=S.cases.filter(x=>x.type===t);return{t:t==='其他'?'其他':t,n:c.length,v:c.reduce((s,x)=>s+(x.contract_amount||0),0)};}).filter(x=>x.n>0);const byS=CASE_STATUS.map(s=>{const c=S.cases.filter(x=>x.status===s);return{s,n:c.length,v:c.reduce((a,x)=>a+(x.contract_amount||0),0)};}).filter(x=>x.n>0);const byC=S.customers.map(cu=>{const c=S.cases.filter(x=>x.customer_id===cu.id);return{name:cu.name,n:c.length,v:c.reduce((s,x)=>s+(x.contract_amount||0),0)};}).sort((a,b)=>b.v-a.v);
return`<h1 class="page-title mb-4">收款統計</h1><div class="grid-2 mb-4"><div class="card"><div class="card-body"><div class="section-title mb-3">依案件類型</div>${byT.map(x=>`<div class="flex justify-between items-center" style="padding:8px 0;border-bottom:1px solid var(--border-light)"><div class="flex items-center gap-2"><span class="tag tag-blue">${x.t}</span><span class="text-xs text-secondary">${x.n} 件</span></div><span class="font-semibold text-sm">${fmt(x.v)}</span></div>`).join('')}</div></div><div class="card"><div class="card-body"><div class="section-title mb-3">依案件狀態</div>${byS.map(x=>`<div class="flex justify-between items-center" style="padding:8px 0;border-bottom:1px solid var(--border-light)"><div class="flex items-center gap-2">${statusTag(x.s)}<span class="text-xs text-secondary">${x.n} 件</span></div><span class="font-semibold text-sm">${fmt(x.v)}</span></div>`).join('')}</div></div></div><div class="card"><div class="card-body"><div class="section-title mb-3">客戶排行</div><table><thead><tr><th>#</th><th>客戶</th><th>案件</th><th>合約總額</th></tr></thead><tbody>${byC.map((x,i)=>`<tr><td class="font-semibold" style="color:${i<3?'var(--amber)':''}">${i+1}</td><td class="font-medium">${x.name}</td><td>${x.n}</td><td class="font-semibold">${fmt(x.v)}</td></tr>`).join('')}</tbody></table></div></div>`;}

if(type==='handler'){const tab=S.analyticsTab;const h={};S.cases.forEach(c=>{if(c.handler){if(!h[c.handler])h[c.handler]={name:c.handler,n:0,v:0,p:0,active:0};h[c.handler].n++;h[c.handler].v+=c.contract_amount||0;h[c.handler].p+=c.paid_amount||0;if(['進行中','已簽約'].includes(c.status))h[c.handler].active++;}});const byH=Object.values(h).sort((a,b)=>b.v-a.v);const allH=[...new Set(S.cases.map(c=>c.handler).filter(Boolean))];const ts={'文組':{n:0,v:0,p:0,active:0},'妮組':{n:0,v:0,p:0,active:0}};byH.forEach(x=>{const t=getTeamOf(x.name);if(t){ts[t].n+=x.n;ts[t].v+=x.v;ts[t].p+=x.p;ts[t].active+=x.active;}});const un=byH.filter(x=>!getTeamOf(x.name));const mx=Math.max(...byH.map(a=>a.v),1);const mN=Math.max(ts['文組'].n,ts['妮組'].n,1);const mV=Math.max(ts['文組'].v,ts['妮組'].v,1);const mA=Math.max(ts['文組'].active,ts['妮組'].active,1);
let tc='';
if(tab==='overview')tc=`<div class="grid-2 mb-4"><div class="card"><div class="card-body"><div class="section-title mb-4">案件量</div><div class="mb-3"><div class="flex justify-between mb-1"><span class="text-sm font-medium">文組</span><span class="text-sm font-semibold">${ts['文組'].n} 件</span></div><div class="team-bar team-a" style="width:${(ts['文組'].n/mN)*100}%">${ts['文組'].n}</div></div><div><div class="flex justify-between mb-1"><span class="text-sm font-medium">妮組</span><span class="text-sm font-semibold">${ts['妮組'].n} 件</span></div><div class="team-bar team-b" style="width:${(ts['妮組'].n/mN)*100}%">${ts['妮組'].n}</div></div></div></div><div class="card"><div class="card-body"><div class="section-title mb-4">合約金額</div><div class="mb-3"><div class="flex justify-between mb-1"><span class="text-sm font-medium">文組</span><span class="text-sm font-semibold">${fmt(ts['文組'].v)}</span></div><div class="team-bar team-a" style="width:${(ts['文組'].v/mV)*100}%"></div></div><div><div class="flex justify-between mb-1"><span class="text-sm font-medium">妮組</span><span class="text-sm font-semibold">${fmt(ts['妮組'].v)}</span></div><div class="team-bar team-b" style="width:${(ts['妮組'].v/mV)*100}%"></div></div></div></div></div><div class="grid-2"><div class="card"><div class="card-body"><div class="section-title mb-4">進行中案件</div><div class="mb-3"><div class="flex justify-between mb-1"><span class="text-sm">文組</span><span class="text-sm font-semibold">${ts['文組'].active} 件</span></div><div class="team-bar team-a" style="width:${mA>0?(ts['文組'].active/mA)*100:0}%">${ts['文組'].active}</div></div><div class="mb-4"><div class="flex justify-between mb-1"><span class="text-sm">妮組</span><span class="text-sm font-semibold">${ts['妮組'].active} 件</span></div><div class="team-bar team-b" style="width:${mA>0?(ts['妮組'].active/mA)*100:0}%">${ts['妮組'].active}</div></div><div style="padding:10px 14px;border-radius:var(--radius);background:var(--surface-hover)"><span class="font-medium text-sm">${ts['文組'].active===ts['妮組'].active?'兩組負荷相同':ts['文組'].active<ts['妮組'].active?'文組目前較有餘裕':'妮組目前較有餘裕'}</span></div></div></div><div class="card"><div class="card-body"><div class="section-title mb-3">彙整</div><table><thead><tr><th>組</th><th>案件</th><th>進行中</th><th>合約</th><th>已收</th><th>%</th></tr></thead><tbody><tr><td><span class="tag tag-blue">文組</span></td><td>${ts['文組'].n}</td><td>${ts['文組'].active}</td><td class="font-semibold">${fmt(ts['文組'].v)}</td><td>${fmt(ts['文組'].p)}</td><td>${ts['文組'].v>0?Math.round(ts['文組'].p/ts['文組'].v*100):0}%</td></tr><tr><td><span class="tag tag-amber">妮組</span></td><td>${ts['妮組'].n}</td><td>${ts['妮組'].active}</td><td class="font-semibold">${fmt(ts['妮組'].v)}</td><td>${fmt(ts['妮組'].p)}</td><td>${ts['妮組'].v>0?Math.round(ts['妮組'].p/ts['妮組'].v*100):0}%</td></tr>${un.length>0?`<tr class="text-secondary"><td><span class="tag tag-gray">未分組</span></td><td>${un.reduce((s,x)=>s+x.n,0)}</td><td>${un.reduce((s,x)=>s+x.active,0)}</td><td>${fmt(un.reduce((s,x)=>s+x.v,0))}</td><td>${fmt(un.reduce((s,x)=>s+x.p,0))}</td><td>-</td></tr>`:''}</tbody></table></div></div></div>`;
if(tab==='detail')tc=`<div class="card mb-4"><div class="card-body"><div class="section-title mb-4">個人業績</div>${byH.length===0?'<div class="empty">尚無資料</div>':byH.map(a=>{const t=getTeamOf(a.name);return`<div class="mb-4"><div class="flex justify-between mb-1"><span class="text-sm font-medium">${a.name} ${t?`<span class="tag tag-${t==='文組'?'blue':'amber'}" style="font-size:10px">${t}</span>`:''} <span class="text-xs text-secondary">${a.active} 件進行中</span></span><span class="text-sm font-semibold">${fmt(a.v)} <span class="text-secondary font-normal">(${a.n} 件)</span></span></div><div style="display:flex;gap:1px;height:20px;border-radius:3px;overflow:hidden;background:var(--border-light)"><div style="width:${(a.p/mx)*100}%;background:var(--green)"></div><div style="width:${((a.v-a.p)/mx)*100}%;background:var(--accent);opacity:.2"></div></div><div class="flex gap-3 mt-1 text-xs text-secondary"><span>已收 ${fmt(a.p)}</span><span>未收 ${fmt(a.v-a.p)}</span></div></div>`;}).join('')}</div></div><div class="card"><div class="card-body"><div class="section-title mb-3">明細</div><table><thead><tr><th>承辦</th><th>組</th><th>案件</th><th>進行中</th><th>合約</th><th>已收</th><th>%</th></tr></thead><tbody>${byH.map(a=>{const t=getTeamOf(a.name);return`<tr><td class="font-medium">${a.name}</td><td>${t?`<span class="tag tag-${t==='文組'?'blue':'amber'}">${t}</span>`:'<span class="tag tag-gray">-</span>'}</td><td>${a.n}</td><td>${a.active}</td><td class="font-semibold">${fmt(a.v)}</td><td>${fmt(a.p)}</td><td>${a.v>0?Math.round(a.p/a.v*100):0}%</td></tr>`;}).join('')}</tbody></table></div></div>`;
if(tab==='settings')tc=`<div class="card"><div class="card-body"><div class="section-title mb-1">分組設定</div><div class="text-xs text-secondary mb-4">勾選後自動儲存，同一人僅歸屬一組</div><div class="grid-2" style="gap:20px"><div style="padding:16px;border-radius:var(--radius-lg);border:1.5px solid var(--accent);background:var(--accent-light)"><div class="flex justify-between mb-3"><span class="font-semibold" style="color:var(--accent)">文組</span><span class="tag tag-blue">${TEAMS['文組'].members.length}</span></div>${allH.map(x=>`<label style="display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:4px;cursor:pointer;font-size:13px;margin-bottom:2px;${TEAMS['文組'].members.includes(x)?'background:var(--accent-muted)':''}"><input type="checkbox" ${TEAMS['文組'].members.includes(x)?'checked':''} onchange="toggleTeamMember('文組','${x}',this.checked)"> ${x}</label>`).join('')}${allH.length===0?'<div class="text-xs text-secondary">先在案件填承辦窗口</div>':''}</div><div style="padding:16px;border-radius:var(--radius-lg);border:1.5px solid var(--amber);background:var(--amber-light)"><div class="flex justify-between mb-3"><span class="font-semibold" style="color:var(--amber)">妮組</span><span class="tag tag-amber">${TEAMS['妮組'].members.length}</span></div>${allH.map(x=>`<label style="display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:4px;cursor:pointer;font-size:13px;margin-bottom:2px;${TEAMS['妮組'].members.includes(x)?'background:var(--amber-border)':''}"><input type="checkbox" ${TEAMS['妮組'].members.includes(x)?'checked':''} onchange="toggleTeamMember('妮組','${x}',this.checked)"> ${x}</label>`).join('')}${allH.length===0?'<div class="text-xs text-secondary">先在案件填承辦窗口</div>':''}</div></div></div></div>`;
return`<h1 class="page-title mb-4">承辦報表</h1><div class="tabs"><button class="tab ${tab==='overview'?'active':''}" onclick="S.analyticsTab='overview';render()">分組總覽</button><button class="tab ${tab==='detail'?'active':''}" onclick="S.analyticsTab='detail';render()">個人明細</button><button class="tab ${tab==='settings'?'active':''}" onclick="S.analyticsTab='settings';render()">分組設定</button></div>${tc}`;}
return'';}

// ─── Nav ───────────────────────────────────────────────────
function viewCust(id){S.selCust=S.customers.find(c=>c.id===id);S.page='customers';S.sub='detail';render();}
function viewCustById(id){if(!id)return;S.selCust=S.customers.find(c=>c.id===id);if(S.selCust){S.page='customers';S.sub='detail';render();}}
async function viewCase(id){S.selCase=S.cases.find(c=>c.id===id);S.page='cases';S.sub='detail';S.attachments=await loadAttachments(id);render();}
function editCust(id){const c=S.customers.find(x=>x.id===id);if(c){S.page='customers';S.sub='edit';S.selCust=c;render();}}
function editCase(id){const c=S.cases.find(x=>x.id===id);if(c){S.page='cases';S.sub='edit';S.selCase=c;render();}}

// ─── Render ────────────────────────────────────────────────
function render(){
  if(!curCompany){document.getElementById('root').innerHTML=`<div class="co-screen"><div><h1>宇豐管理系統</h1><p>選擇要管理的公司</p><div class="co-cards"><div class="co-card" onclick="selectCompany('宇豐估價')"><div class="co-emoji">🏢</div><h2>宇豐估價</h2><p>不動產估價</p></div><div class="co-card" onclick="selectCompany('宇豐顧問')"><div class="co-emoji">📋</div><h2>宇豐顧問</h2><p>都更顧問</p></div></div></div></div>`;return;}
  let el=document.getElementById('app');if(!el){document.getElementById('root').innerHTML='<div id="app" class="app"></div>';el=document.getElementById('app');}
  let content='';
  if(S.loading)content='<div class="loading"><div class="spinner"></div></div>';
  else switch(S.page){
    case'dashboard':content=rDash();break;
    case'customers':if(S.sub==='detail'&&S.selCust)content=rCustDet();else if(S.sub==='create')content=rCustForm();else if(S.sub==='edit'&&S.selCust)content=rCustForm(S.selCust);else if(S.sub==='gifts')content=rGifts();else content=rCustList();break;
    case'cases':if(S.sub==='detail'&&S.selCase)content=rCaseDet();else if(S.sub==='create')content=rCaseForm();else if(S.sub==='edit'&&S.selCase)content=rCaseForm(S.selCase);else content=rCaseList();break;
    case'payments':content=rPay();break;
    case'analytics':content=rAnalytics(S.sub);break;
    default:content=rDash();
  }
  el.innerHTML=`${rSide()}<div class="main">${content}</div>`;
  setTimeout(bindSearch,10);
  if(S.page==='cases'&&S.sub==='create'&&!S.selCase)setTimeout(()=>{genPm();recalcAll();},50);
}
render();if(sb&&curCompany)loadData();
</script>
</body>
</html>
